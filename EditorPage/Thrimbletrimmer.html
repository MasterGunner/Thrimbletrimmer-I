<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

	<title>Eustace W. Thrimbletrimmer Editing Suite</title>
  
	<script src="scripts/jquery-2.1.3.min.js"></script>
	<script src="scripts/jquery-ui-1.11.4/jquery-ui.js"></script>
	<script src="scripts/wubPlayerControls.js"></script>
	<script src="scripts/wubEditorControls.js"></script>
	<script src="https://apis.google.com/js/platform.js?onload=onGLoad" async defer></script>
	<link rel="stylesheet" href="scripts/jquery-ui-1.11.4/jquery-ui.css">
	<link rel="stylesheet" href="styles/wubPlayerControls.css">
	<link rel="stylesheet" href="styles/wubEditorControls.css">
	<meta name="google-signin-client_id" content="345276493482-r84m2giavk10glnmqna0lbq8e1hdaus0.apps.googleusercontent.com">
</head>
<body>
	<div id="Sign-in" style="display:none;float:left;">
		<div class="g-signin2" data-onsuccess="onSignIn" data-onfailure="signInFailure" data-theme="dark"></div>
		<span id="g-signin-response"></span>
		<span id="g-signin-sessionId" style="display:none;"></span>
		<script type="text/javascript">
			function onGLoad() {
				window.gapi.auth2.getAuthInstance().then(function() {
					if(!window.gapi.auth2.getAuthInstance().isSignedIn.get()) {
						signInFailure("Not signed in or authenticated.");
					}
				}, function(error) {signInFailure(error);});
			}
			function onSignIn(googleUser) {
				var id_token = googleUser.getAuthResponse().id_token;
				var xhr = new XMLHttpRequest();
				xhr.open('POST', '/tokensignin');
				xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
				xhr.onload = function() {
					console.log(xhr.responseText);
					var resData = JSON.parse(xhr.responseText);
					$('#g-signin-response').text(resData.Response);
					if(resData.Response == "User Authenticated" && resData.SessionId) {
						$('#g-signin-sessionId').text(resData.SessionId);
						$('#Sign-in').hide();
						$('#EditorContent').show();
						PageSetup();
					} else { signInFailure("Not signed in or authenticated."); }
				};
				xhr.send('id_token=' + id_token);
			}
			function signInFailure(error) {
				console.log(error);
				$('#Sign-in').show();
				$('#EditorContent').hide();
			}
		</script>
	</div>
	<div style="float:right;">
		<a href="#" onclick="signOut();">Sign out</a>
		<script>
		  function signOut() {
			var auth2 = gapi.auth2.getAuthInstance();
			auth2.signOut().then(function () {
			  console.log('User signed out.');
			  window.location.reload();
			});
		  }
		</script>
	</div>
	<div id="EditorContent" style="float:left;"></div>
	<script type="text/javascript">
		var path = window.location.protocol + '//' + window.location.hostname;
		var _startOffset = 10;
		var _endOffset = 10;
		
		var getExtraData = function() {
			var extraData = [{SessionId:$('#g-signin-sessionId').text()}];
			return extraData;
		}
		
		var CallForWubs = function(Callback) {
			if(window.location.search.match(/video=(.*?)(&|$)/i)) {
				var videoID = window.location.search.match(/video=(.*?)(&|$)/i)[1];
				$.get('/getwubs/'+videoID+'?SessionId='+$('#g-signin-sessionId').text(),function(data) { Callback(data); },'json');
			}
		};
		
		var InsertVideo = function(wubs) {
			$('#EditorContent').append('<video id="wubPlayer" width="'+wubs.width+'" height="'+wubs.height+'" style="padding-top:2px;" vidID='+wubs.vidID+'>' +
											'<source src="'+wubs.src+'" type="'+wubs.type+'" />' +
											'Your browser does not support HTML5 video.' +
										'</video>');
			$('#wubPlayer').wVideo({startOffset:_startOffset}); //Set start time for playing the video.
			//Call the video editor controls plugin.
			$('#wubPlayer').wEditor({submitLoc:'/setwubs', startOffset:_startOffset, endOffset:_endOffset, vidID:wubs.vidID, title:wubs.title, description:wubs.description, extraMetadata:getExtraData});
			
		};
		
		var PageSetup = function() {
			CallForWubs(InsertVideo);
		};
	</script>
</body>
</html>