var fs=require("fs"),GoogleAuth=require("google-auth-library"),Xannathor;!function(e){var t;!function(e){function t(e){console.log(e)}function i(e){var t=!1;return e.vidID&&e.start&&e.end&&e.title&&e.description&&e.start<e.end&&e.title.length<=91&&(t=!0),t}function n(t,i){var n=function(t,n){if(t)e.log("Error Authenticating OAuth Token:"),e.log(t),i(!1,null);else{var o=n.getPayload(),r=o.email,s=fs.readFileSync("../Resources/AuthenticatedUserList.txt").toString().split("\n");s.indexOf(r)>=0?(e.log("User Authenticated: "+r),i(!0,e.generateSessionId(o))):(e.log("User Not Authenticated: "+r),i(!1,null))}};try{(new((new GoogleAuth).OAuth2)).verifyIdToken(t,null,n)}catch(o){e.log(o)}}function o(e){return"1234567890"}function r(e){return"1234567890"==e?!0:!1}e.log=t,e.validateVideoSubmission=i,e.auth=n,e.generateSessionId=o,e.validateSessionId=r}(t=e.Utilities||(e.Utilities={}))}(Xannathor||(Xannathor={}));var fs=require("fs"),Xannathor;!function(e){var t;!function(t){function i(e,t){return r.push([e,t]),"/Thrimbletrimmer.html?Video="+e}function n(t){var i=null;try{for(var n=JSON.parse(fs.readFileSync("../Videos/videolist.json","utf8")),o=0;o<n.length;o++)if(n[o].vidID==t){var r=n[o],s={vidID:r.vidID,src:r.src,type:r.type,title:r.title,description:r.description,framerate:r.framerate,width:r.width,height:r.height};i=s;break}}catch(a){e.Utilities.log(a)}return i}function o(t){var i=!1;if(e.Utilities.validateVideoSubmission(t))try{for(var n=0;n<r.length;n++)if(r[n][0]==t.vidID){r[n][1](t),r.splice(n,1),i=!0;break}}catch(o){e.Utilities.log(o)}return i}var r=[];t.newVideo=i,t.getVideo=n,t.submitVideo=o}(t=e.WubloaderIntegration||(e.WubloaderIntegration={}))}(Xannathor||(Xannathor={}));var express=require("express"),bodyParser=require("body-parser"),Xannathor;!function(e){var t;!function(t){var i=function(){function t(){this.app=express(),this.configureServerDefaults(),this.configureGoogleAuth(),this.configureVideoFunctions(),this.app.listen(1337),e.Utilities.log("Server running at http://127.0.0.1:1337/")}return t.prototype.configureServerDefaults=function(){this.app.use(bodyParser.json()),this.app.use(bodyParser.urlencoded({extended:!1})),this.app.use(express["static"]("../EditorPage")),this.app.use(express["static"]("../Videos")),this.app.get("/",function(e,t){t.sendFile("default.html",{root:__dirname+"/../Resources"})})},t.prototype.configureGoogleAuth=function(){this.app.post("/tokensignin",function(t,i){e.Utilities.auth(t.body.id_token,function(e,t){if(e){var n={Response:"User Authenticated",SessionId:t};i.json(n)}else{var n={Response:"User Not Authenticated",SessionId:t};i.json(n)}})})},t.prototype.configureVideoFunctions=function(){this.app.get("/getwubs/:a?",function(t,i){if(e.Utilities.validateSessionId(t.query.SessionId)){var n=e.WubloaderIntegration.getVideo(t.params.a);n?i.json(n):i.sendStatus(400)}else i.sendStatus(401)}),this.app.post("/setwubs",function(t,i){e.Utilities.log(t.body),e.Utilities.validateSessionId(t.body["extraMetadata[0][SessionId]"])?e.WubloaderIntegration.submitVideo(t.body)?i.send("Recieved Video Edits"):i.sendStatus(500):i.sendStatus(401)})},t.prototype.newVideo=function(t,i){return e.WubloaderIntegration.newVideo(t,i)},t}();t.Server=i}(t=e.Xannathor||(e.Xannathor={}))}(Xannathor||(Xannathor={}));